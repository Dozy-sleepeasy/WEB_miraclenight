//
// SleepAnalysisCalculator.swift
// MiracleNight
//
// Created by paige shin on 2022/10/26.
//
import HealthKit
import Foundation
struct SleepAnalsysisDataModel {
  let type: SleepType
  let startDate: Date
  let endDate: Date
  enum SleepType {
    case awake
    case asleepCore
    case inBed
    case asleepDeep
    case asleepREM
    case asleepUnspecified
  }
}
struct SleepAnalysisFactory {
  static func makeSleepAnalysis(start: Date, end: Date, data samples: [HKSample]) -> SleepAnalysis {
    let totalSleepTime: Double = end.timeIntervalSince1970 - start.timeIntervalSince1970
    let deepAverage: Double = (end.timeIntervalSince1970 - start.timeIntervalSince1970) * 0.13
    let coreAverage: Double = (end.timeIntervalSince1970 - start.timeIntervalSince1970) * 0.6
    let awakeAverage: Double = 2.5
    var results: [SleepAnalsysisDataModel] = []
    for item in samples {
      if let sample: HKCategorySample = item as? HKCategorySample {
        if #available(iOS 16.0, *) {
          switch sample.value {
          case HKCategoryValueSleepAnalysis.asleepCore.rawValue:
            results.append(SleepAnalsysisDataModel(type: .asleepCore, startDate: sample.startDate, endDate: sample.endDate))
          case HKCategoryValueSleepAnalysis.inBed.rawValue:
            results.append(SleepAnalsysisDataModel(type: .inBed, startDate: sample.startDate, endDate: sample.endDate))
          case HKCategoryValueSleepAnalysis.asleepDeep.rawValue:
            results.append(SleepAnalsysisDataModel(type: .asleepDeep, startDate: sample.startDate, endDate: sample.endDate))
          case HKCategoryValueSleepAnalysis.asleepREM.rawValue:
            results.append(SleepAnalsysisDataModel(type: .asleepREM, startDate: sample.startDate, endDate: sample.endDate))
          case HKCategoryValueSleepAnalysis.awake.rawValue:
            results.append(SleepAnalsysisDataModel(type: .awake, startDate: sample.startDate, endDate: sample.endDate))
          case HKCategoryValueSleepAnalysis.asleepUnspecified.rawValue:
            results.append(SleepAnalsysisDataModel(type: .asleepUnspecified, startDate: sample.startDate, endDate: sample.endDate))
          default: print(“None”)
          }
        } else {
          switch sample.value {
          case HKCategoryValueSleepAnalysis.inBed.rawValue:
            //                    self.results.append(“In Bed, \(sample.startDate)“)
            break
          case HKCategoryValueSleepAnalysis.awake.rawValue:
            //                    self.results.append(“Awake, \(sample.startDate)“)
            break
          case HKCategoryValueSleepAnalysis.asleep.rawValue:
            //                    self.results.append(“Asleep, \(sample.startDate)“)
            break
          default: print(“None”)
          }
        }
      }
    }
    let deepSleeps: [SleepAnalsysisDataModel] = results.filter { $0.type == .asleepDeep }
    let totalDeepSleepTime: Double = deepSleeps.reduce(0) { partialResult, dataModel in
      return partialResult + (dataModel.endDate.timeIntervalSince1970 - dataModel.startDate.timeIntervalSince1970)
    }
    let deepSleepResult: Double = self.getDeepSleepResult(totalDeepSleepTime: totalDeepSleepTime, totalSleepTime: totalSleepTime)
    // 옅은 잠
    let coreSleeps: [SleepAnalsysisDataModel] = results.filter { $0.type == .asleepCore }
    let totalCoreSleepTime: Double = coreSleeps.reduce(0, { partialResult, dataModel in
      return partialResult + (dataModel.endDate.timeIntervalSince1970 - dataModel.startDate.timeIntervalSince1970)
    })
    let coreSleepResult: Double = self.getCoreSleepResult(totalCoreSleepTime: totalCoreSleepTime, totalSleepTime: totalSleepTime)
    // 깨어남 횟수
    let awakeCounts: Int = results.filter { $0.type == .awake }.count
    let awakeResult: Double = self.getAwakeCounts(totalAwakeCounts: Double(awakeCounts), totalSleepTime: totalSleepTime)
    return SleepAnalysis(averages: SleepAnalysis.Average(deep: deepAverage,
                               core: coreAverage,
                               awake: awakeAverage),
               seconds: SleepAnalysis.Seconds(awake: self.getSeconds(results: results, type: .awake),
                              asleepCore: self.getSeconds(results: results, type: .asleepCore),
                              inBed: self.getSeconds(results: results, type: .inBed),
                              asleepDeep: self.getSeconds(results: results, type: .asleepDeep),
                              asleepREM: self.getSeconds(results: results, type: .asleepREM),
                              asleepUnspecified: self.getSeconds(results: results, type: .asleepUnspecified)),
               results: SleepAnalysis.Result(deep: deepSleepResult,
                              awake: awakeResult,
                              core: coreSleepResult),
               count: SleepAnalysis.Count(awake: self.getCounts(results: results, type: .awake),
                            asleepCore: self.getCounts(results: results, type: .asleepCore),
                            inBed: self.getCounts(results: results, type: .inBed),
                            asleepDeep: self.getCounts(results: results, type: .asleepDeep),
                            asleepREM: self.getCounts(results: results, type: .asleepREM),
                            asleepUnspecified: self.getCounts(results: results, type: .asleepREM)))
  }
  private static func getSeconds(results: [SleepAnalsysisDataModel], type: SleepAnalsysisDataModel.SleepType) -> Double {
    return results.filter { $0.type == type }.reduce(0, { $0 + ($1.endDate.timeIntervalSince1970 - $1.startDate.timeIntervalSince1970) })
  }
  private static func getCounts(results: [SleepAnalsysisDataModel], type: SleepAnalsysisDataModel.SleepType) -> Int {
    return results.filter { $0.type == type }.count
  }
  private static func getDeepSleepResult(totalDeepSleepTime: Double, totalSleepTime: Double) -> Double {
    //[{사용자의 깊은 수면 시간 - (0.13*전체 수면 시간)}/(0.13*전체 수면 시간)]*100
    // Y = 0.13*전체 수면 시간
    let Y = 0.13 * totalSleepTime
    // X = 사용자의 깊은 수면 시간 - (0.13*전체 수면 시간)
    let X = totalDeepSleepTime - Y
    return (X / Y) * 100
  }
  // 옅은 잠
  private static func getCoreSleepResult(totalCoreSleepTime: Double, totalSleepTime: Double) -> Double {
    //[{사용자의 옅은 수면 시간 - (0.60*전체 수면 시간)}/(0.60*전체 수면 시간)]*100
    // Y = 0.60*전체 수면 시간
    let Y = 0.6 * totalSleepTime
    // X = 사용자의 옅은 수면 시간 - (0.60*전체 수면 시간)
    let X = totalCoreSleepTime - Y
    return (X / Y) * 100
  }
  private static func getAwakeCounts(totalAwakeCounts: Double, totalSleepTime: Double) -> Double {
    // [{2.5 - 사용자의 Awake 횟수}/(사용자의 Awake 횟수)]*100
    // - 양수 값 나오면 “평균보다 ____% 높음”
    // - 음수 값 나오면 “평균보다 ____% 낮음”
    return ((2.5 - totalAwakeCounts) / totalAwakeCounts) * 100
  }
}